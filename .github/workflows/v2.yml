name: Go

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:

    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.15
      id: go

    - name: Debug
      run: |
        pwd
        echo $(go env GOPATH)
        echo ${GOROOT}

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Get dependencies
      run: |
        export GOPATH=$(go env GOPATH) 
        mkdir -p /opt/v2

    - name: Build source
      run: |
        go get -insecure -u v2ray.com/core/...
        cd ${GOPATH}/src/v2ray.com/core/
        sed -i 's/_ "v2ray.com\/core\/main\/json"/\/\/ &/g; s/\/\/ _ "v2ray.com\/core\/main\/jsonem"/_ "v2ray.com\/core\/main\/jsonem"/g' main/distro/all/all.go
        bazel clean
        bazel build --action_env=PATH=$PATH --action_env=SPWD=$PWD --action_env=GOPATH=$(go env GOPATH) --action_env=GOCACHE=$(go env GOCACHE) --spawn_strategy local //release:v2ray_linux_mips32le_package
    
    - name: Compress binary
      run: |
        cd  $HOME
        find -name "v2ray*zip" -exec mv -t . {} +
        unzip v2ray-linux-mips32le.zip
        upx -k --best --lzma -o /opt/v2/v2ray v2ray_softfloat
        
    - name : Upload packages
      uses: actions/upload-artifact@master
      if: always()
      with:
        name: V2-package
        path: /opt/v2
